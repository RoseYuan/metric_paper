```{r}
suppressPackageStartupMessages({
    library(ggplot2)
    library(patchwork)
    library(dplyr)
  })
```

```{r}
devtools::load_all("~/public/SiyuanLuo/projects/clustering_metrics/ClusteringMetrics")
```

```{r}
moon_maker <- function(n = 50, noise = 0.1,
                         x_center = 0, y_center = 0, radius = 1, seed=42) {
    set.seed(seed)
    moon <- tibble(
      i = 1:n,
      x = x_center + radius * cos(pi * i/n) + rnorm(n, 0, sd = noise * radius),
      y = y_center + radius * sin(pi * i/n) + rnorm(n, 0, sd = noise * radius),
    )
    return(data.frame(moon))
  }
```

```{r}
# Combine the data into a data frame for easier manipulation
df1 <- moon_maker(n = 100, x_center = 1, y_center = -1)
df1$label = 1
df2 <- moon_maker(n = 100, x_center = 2, y_center = 0.5)
df2$label = 2
df2$y <- - df2$y
data <- rbind(df1, df2)
data$label <- as.factor(data$label)
noisy_moon <- data[, c("x", "y", "label")]

# Perform K-means clustering
kmeans_result <- kmeans(data, centers = 2)
kmeans_labels <- kmeans_result$cluster
noisy_moon$kmeans_label <- factor(kmeans_labels)

# Perform HDBSCAN clustering
library(dbscan)
hdbscan_result <- hdbscan(as.matrix(data[,c("x", "y")]), minPts = 5)
hdbscan_labels <- hdbscan_result$cluster
noisy_moon$hdbscan_label <- factor(hdbscan_labels)
data <- noisy_moon
```

```{r}
p1 <- ggplot(data, aes(x, y, color=kmeans_label)) + 
  geom_point() +
  theme_bw() + labs(color="kmeans cluster")

p2 <- ggplot(data, aes(x, y, color=hdbscan_label)) + 
  geom_point() +
  theme_bw() + labs(color="HDBSCAN cluster")
```

```{r}
library(tidyr)
res1 <- getEmbeddingGlobalMetrics(data[,c("x","y")], data$kmeans_label)
res2 <- getEmbeddingGlobalMetrics(data[,c("x","y")], data$hdbscan_label)
res1 <- pivot_longer(res1, cols = colnames(res1), names_to = "metric")
res1$scenario <- "A"
res2 <- pivot_longer(res2, cols = colnames(res2), names_to = "metric")
res2$scenario <- "B"
p3 <- rbind(res1, res2) %>% ggplot(aes(x=metric, y=value, fill=scenario)) + geom_col(position = "dodge") + theme_bw() + theme(axis.text.x = element_text(angle = 30, vjust = 0.5)) + labs(fill="Scenario")
```


```{r}
pdf(file="convexity.pdf", width=7, height=7)
cowplot::plot_grid(p1, p2, p3,  labels=LETTERS[1:3], nrow=3)
dev.off()
```





