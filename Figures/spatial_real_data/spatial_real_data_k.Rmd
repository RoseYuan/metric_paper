---
title: "Spatial real data with changing k"
output: html_document
date: "2024-05-23"
---

```{r}
library(ggplot2)
library(tidyr)
library(cowplot)
library(dplyr)
library(ComplexHeatmap)
library(ggokabeito)
devtools::load_all("~/public/SiyuanLuo/projects/clustering_metrics/ClusteringMetrics")
```

```{r}
df <- readRDS(file="../../spatial_real_data/obs_Br8100_151673_spe_coldata.RDS")
```

```{r}
true <- factor(as.integer(df$ground_truth))
clusterlabels <- factor(df$BayesSpace_default)
location <- df[,c("pxl_col_in_fullres","pxl_row_in_fullres")]

global <- data.frame(matrix(ncol = 6, nrow = 0))
colnames(global) <- c("metric","value","k")
for (k in c(6, 18, 30, 42)) {
  tmp <- getSpatialGlobalInternalMetrics(clusterlabels, location, k=k, metrics=c("PAS", "ELSA"))
  agg <- getSpatialGlobalExternalMetrics(true, clusterlabels, location, k=k, metrics=c("SpatialARI"))
  tmp <- c(tmp, agg)
  tmp<- data.frame(value=tmp)
  tmp$metric <- rownames(tmp)
  tmp$k <- paste0("k=",k)
  global <- rbind(global, tmp)
}
global$k <- factor(global$k, levels=c("k=6","k=18","k=30","k=42"))
```

```{r}
# global$metric <- factor(global$metric)
p0 <- global %>% filter(metric %in% c("PAS", "ELSA","SpatialARI")) %>%
  ggplot(aes(k, value, group=metric, color=metric)) +
  geom_point(size=2) + geom_line(size=0.8) +
  scale_color_okabe_ito(order=c(6,3,2,7,1)) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8), 
        ) +
  guides(color = guide_legend(nrow = 3, keywidth = 0.8, keyheight = 0.8, override.aes = list(size = 0.8))) 
p0
```

```{r}
res <- data.frame(matrix(ncol = 6, nrow = 0))
colnames(res) <- c("PAS", "ELSA", "ELSA.Ea", "ELSA.Ec","SpatialAgreement","k")
for (k in c(6, 18, 30, 42)) {
  tmp <- getSpatialInternalMetrics(clusterlabels, location, k=k, metrics=c("PAS", "ELSA"))
  agg <- getFuzzyPartitionMetrics(true, clusterlabels, location, k=k, returnElementPairAccuracy=TRUE)
  tmp$"SpatialAgreement" <- agg
  tmp$k <- paste0("k=",k)
  tmp$row <- df$row
  tmp$col <- df$col
  tmp$BayesSpace <- clusterlabels
  res <- rbind(res, tmp)
}

```
```{r}
dfl <- as.data.frame(res %>% pivot_longer(cols = c("PAS", "ELSA", "ELSA.Ea", "ELSA.Ec","SpatialAgreement"), names_to="metric", values_to = "value"))
dfl$k <- factor(dfl$k, levels=c("k=6","k=18","k=30","k=42"))
```


```{r}
s <- 0.3
df$ground_truth_label <- df$ground_truth_recode %>% recode("1" = "1", "2" = "1",
                                                           "5" = "1", "3" = "1",
                                                           "4" = "0", "6" = "0", "7" = "0")
p1 <- ggplot(df) +
  geom_tile(height=2, width=2, aes(x = col, y = -row, fill=ground_truth_label)) +
  geom_point(aes(x = col, y = -row, color = BayesSpace_default), size = s) +
  labs(x = "", y = "", title="BayesSpace", fill="Annotation") +
  theme_minimal() +
  scale_color_okabe_ito(order=c(6,1,2,7,3,5,4)) +
  scale_fill_manual(values=c("0"="grey40", "1"="white")) +
  theme(
  legend.box.background = element_rect(fill = "grey90", color = "black", size = 0.1),
  legend.title = element_text(size = 8),
  legend.text = element_text(size = 8),  # Adjusts the font size of the legend items
  legend.box.margin = margin(-1, -1, -1, -1), 
  axis.title.x=element_blank(),
  plot.title = element_text(hjust = 0.5, margin = margin(b = -3), size=10), 
  legend.position = c(0.5, 0.04), legend.direction = "horizontal",
  axis.text.x=element_blank(), axis.ticks.x=element_blank(),
  axis.text.y=element_blank(), axis.ticks.y=element_blank(),
  panel.spacing.x = unit(-1, "cm"),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  plot.margin = margin(1, -5, -5, -1)
  ) +
  guides(color="none", fill = guide_legend(keywidth = 0.3, keyheight = 0.3, nrow=1, override.aes = list(size = 0.3)))

p1
```
```{r}
st <- 0.2
p2 <- dfl %>% filter(metric == "PAS") %>% filter(k %in% c("k=6","k=42")) %>%
  mutate(value = as.logical(value)) %>%
  ggplot(aes(x = col, y = -row, color = BayesSpace)) +
  geom_point(size=0.6, aes(shape=value), stroke = st) + 
  geom_point(shape = 1, size = 0.6, stroke = st, aes(color=BayesSpace)) +
  labs(x = "", y = "", color="") +
  theme_minimal() +
  facet_wrap(~k, nrow=1) +
  scale_color_okabe_ito(order=c(6,1,2,7,3,5,4)) +
  theme(
  legend.title = element_text(size = 9),
  legend.box.margin = margin(-1, -1, -1, -1),
  axis.title.x=element_blank(),
  legend.position = "right",
  axis.text.x=element_blank(),
  axis.ticks.x=element_blank(),
  axis.text.y=element_blank(),
  axis.ticks.y=element_blank(),
  panel.spacing.x = unit(-0.1, "cm"),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  plot.margin = margin(1, 1, -2, 0)
  ) +
  scale_shape_manual(values = c(1, 8)) +
  guides(color = guide_legend(keywidth = 1, keyheight = 0.8, override.aes = list(size = 3)),
         shape = guide_legend(keywidth = 1, keyheight = 0.8, override.aes = list(size = 3))) +
  labs(color="BayesSpace\nPrediction", shape="Abnormal\nSpots")

p2
```

```{r}
st <- 0.5
s <- 0.3
p3 <- dfl %>% filter(metric == "ELSA") %>% #filter(k != "k=30") %>%
  ggplot(aes(x = col, y = -row, color = value)) +
  geom_point(size=s, stroke = st) + 
  labs(x = "", y = "", color="") +
  theme_minimal() +
  facet_wrap(~k, nrow=1) +
  scico::scale_color_scico(palette = "roma", limits = c(0, 1)) +
  theme(
  legend.title = element_text(size = 9),
  legend.box.margin = margin(-1, -1, -1, -1),
  axis.title.x=element_blank(),
  legend.position = "right",
  axis.text.x=element_blank(),
  axis.ticks.x=element_blank(),
  axis.text.y=element_blank(),
  axis.ticks.y=element_blank(),
  panel.spacing.x = unit(0, "cm"),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), 
  plot.margin = margin(1, 1, -2, 0)
  ) +
  # scale_shape_manual(values = c(1, 8)) +
  # guides(color = guide_legend(keywidth = 1, keyheight = 0.8, override.aes = list(size = 3)),
  #        shape = guide_legend(keywidth = 1, keyheight = 0.8, override.aes = list(size = 3))) +
  labs(color="ELSA")

p3
```

```{r}
st <- 0.5
p4 <- dfl %>% filter(metric == "SpatialAgreement") %>% filter(k != "k=30") %>%
  ggplot(aes(x = col, y = -row, color = value)) +
  geom_point(size=s, stroke = st) + 
  labs(x = "", y = "", color="") +
  theme_minimal() +
  facet_wrap(~k, nrow=1) +
  scico::scale_color_scico(palette = "roma", limits = c(0, 1), direction=-1) +
  theme(
  # legend.box.background = element_rect(fill = "grey90", color = "black", size = 0.1),
  legend.title = element_text(size = 9),
  legend.box.margin = margin(-1, -1, -1, -1),
  axis.title.x=element_blank(),
  legend.position = "right",
  axis.text.x=element_blank(),
  axis.ticks.x=element_blank(),
  axis.text.y=element_blank(),
  axis.ticks.y=element_blank(),
  panel.spacing.x = unit(0, "cm"),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
    plot.margin = margin(1, 1, -2, 0)
  ) +
  # scale_shape_manual(values = c(1, 8)) +
  # guides(color = guide_legend(keywidth = 1, keyheight = 0.8, override.aes = list(size = 3)),
  #        shape = guide_legend(keywidth = 1, keyheight = 0.8, override.aes = list(size = 3))) +
  labs(color="Spatial\nAgreement\n/SPA")

p4
```

```{r}
spa <- getAgreement(clusterlabels, true, usePairs=TRUE)

p6 <- cbind(df[,c("row","col")], data.frame(spa=spa)) %>% ggplot() +
  geom_point(aes(x = col, y = -row, color = spa), size = s) +
  labs(x = "", y = "", color="") +
  theme_minimal() +
  scico::scale_color_scico(palette = "roma", limits = c(0, 1), direction=-1) +
  theme(
  legend.title = element_text(size = 9),
  legend.box.margin = margin(-1, -1, -1, -1),
  axis.title.x=element_blank(),
  legend.position = "None",
  axis.text.x=element_blank(),
  axis.ticks.x=element_blank(),
  axis.text.y=element_blank(),
  axis.ticks.y=element_blank(),
  panel.spacing.x = unit(0, "cm"),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), 
  plot.margin = margin(5, -5, -2, -5),
  plot.title = element_text(hjust = 0.5, size=10)
  ) +
  labs(color="SPA",title="SPA")
p6
```

```{r}
pdf("spatial_metrics_real_data.pdf", width=9.5, height=7)
p5 <- cowplot::plot_grid(p1, p0, p2, rel_widths=c(1,0.8,2.2), ncol=3, labels=letters[1:3], scale=c(1, 1))
p7 <- cowplot::plot_grid(p6, 
                         p4, 
                         rel_widths=c(1,3.2), ncol=2, labels=c("e",""), scale=c(1, 1))
cowplot::plot_grid(p5, p3, p7, rel_heights=c(1,1,1), ncol=1, labels=c("","d",""), scale=c(1, 1))
dev.off()
```


